<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/http-transport.js - wpapi</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                    <h1 class="project-name">wpapi</h1> <span class="project-version">0.11.0</span>
                    <p class="description">A client for interacting with the WordPress REST API</p>
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs">
            <div id="api-list">
                <div id="api-tabview" class="tabview">
                    <ul class="tabs">
                        <li><a href="#api-classes">Classes</a></li>
                        <li><a href="#api-modules">Modules</a></li>
                    </ul>
            
                    <div id="api-tabview-filter">
                        <input type="search" id="api-filter" placeholder="Type to filter APIs">
                    </div>
            
                    <div id="api-tabview-panel">
                        <ul id="api-classes" class="apis classes">
                            <li><a class="type" href="../classes/WPAPI.html">WPAPI</a></li>
                            <li><a class="type" href="../classes/WPRequest.html">WPRequest</a></li>
                        </ul>
            
                        <ul id="api-modules" class="apis modules">
                            <li><a class="module" href="../modules/autodiscovery.html">autodiscovery</a></li>
                            <li><a class="module" href="../modules/filters.html">filters</a></li>
                            <li><a class="module" href="../modules/http-transport.html">http-transport</a></li>
                            <li><a class="module" href="../modules/parseRouteString.html">parseRouteString</a></li>
                            <li><a class="module" href="../modules/WPAPI.html">WPAPI</a></li>
                            <li><a class="module" href="../modules/WPRequest.html">WPRequest</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="docs-main" class="apidocs">
            <div class="content container">
                <h1 class="file-heading">File: lib/http-transport.js</h1>
                
                <div class="file">
                    <pre class="code prettyprint linenums">
                &#x27;use strict&#x27;;
                /**
                 * @module http-transport
                 */
                
                /*jshint -W079 */// Suppress warning about redefiniton of &#x60;Promise&#x60;
                var Promise = require( &#x27;es6-promise&#x27; ).Promise;
                
                var _reduce = require( &#x27;lodash.reduce&#x27; );
                var agent = require( &#x27;superagent&#x27; );
                var parseLinkHeader = require( &#x27;li&#x27; ).parse;
                var url = require( &#x27;url&#x27; );
                
                var WPRequest = require( &#x27;./constructors/wp-request&#x27; );
                var checkMethodSupport = require( &#x27;./util/check-method-support&#x27; );
                
                /**
                 * Conditionally set basic authentication on a server request object
                 *
                 * @method _auth
                 * @private
                 * @param {Object} request A superagent request object
                 * @param {Object} options A WPRequest _options object
                 * @param {Boolean} forceAuthentication whether to force authentication on the request
                 * @param {Object} A superagent request object, conditionally configured to use basic auth
                 */
                function _auth( request, options, forceAuthentication ) {
                	// If we&#x27;re not supposed to authenticate, don&#x27;t even start
                	if ( ! forceAuthentication &amp;&amp; ! options.auth &amp;&amp; ! options.nonce ) {
                		return request;
                	}
                
                	// Enable nonce in options for Cookie authentication http://wp-api.org/guides/authentication.html
                	if ( options.nonce ) {
                		request.set( &#x27;X-WP-Nonce&#x27;, options.nonce );
                		return request;
                	}
                
                	// Retrieve the username &amp; password from the request options if they weren&#x27;t provided
                	var username = username || options.username;
                	var password = password || options.password;
                
                	// If no username or no password, can&#x27;t authenticate
                	if ( ! username || ! password ) {
                		return request;
                	}
                
                	// Can authenticate: set basic auth parameters on the request
                	return request.auth( username, password );
                }
                
                // Pagination-Related Helpers
                // ==========================
                
                /**
                 * Combine the API endpoint root URI and link URI into a valid request URL.
                 * Endpoints are generally a full path to the JSON API&#x27;s root endpoint, such
                 * as &#x60;website.com/wp-json&#x60;: the link headers, however, are returned as root-
                 * relative paths. Concatenating these would generate a URL such as
                 * &#x60;website.com/wp-json/wp-json/posts?page=2&#x60;: we must intelligently merge the
                 * URI strings in order to generate a valid new request URL.
                 *
                 * @param endpoint {String} The endpoint URL for the REST API root
                 * @param linkPath {String} A root-relative link path to an API request
                 * @returns {String} The full URL path to the provided link
                 */
                function mergeUrl( endpoint, linkPath ) {
                	var request = url.parse( endpoint );
                	linkPath = url.parse( linkPath, true );
                
                	// Overwrite relevant request URL object properties with the link&#x27;s values:
                	// Setting these three values from the link will ensure proper URL generation
                	request.query = linkPath.query;
                	request.search = linkPath.search;
                	request.pathname = linkPath.pathname;
                
                	// Reassemble and return the merged URL
                	return url.format( request );
                }
                
                /**
                 * If the response is not paged, return the body as-is. If pagination
                 * information is present in the response headers, parse those headers into
                 * a custom &#x60;_paging&#x60; property on the response body. &#x60;_paging&#x60; contains links
                 * to the previous and next pages in the collection, as well as metadata
                 * about the size and number of pages in the collection.
                 *
                 * The structure of the &#x60;_paging&#x60; property is as follows:
                 *
                 * - &#x60;total&#x60; {Integer} The total number of records in the collection
                 * - &#x60;totalPages&#x60; {Integer} The number of pages available
                 * - &#x60;links&#x60; {Object} The parsed &quot;links&quot; headers, separated into individual URI strings
                 * - &#x60;next&#x60; {WPRequest} A WPRequest object bound to the &quot;next&quot; page (if page exists)
                 * - &#x60;prev&#x60; {WPRequest} A WPRequest object bound to the &quot;previous&quot; page (if page exists)
                 *
                 * @param result {Object} The response object from the HTTP request
                 * @param endpoint {String} The base URL of the requested API endpoint
                 * @returns {Object} The body of the HTTP request, conditionally augmented with
                 *                   pagination metadata
                 */
                function paginateResponse( result, endpoint, httpTransport ) {
                	if ( ! result.headers || ! result.headers[ &#x27;x-wp-totalpages&#x27; ] ) {
                		// No headers: return as-is
                		return result;
                	}
                
                	var totalPages = result.headers[ &#x27;x-wp-totalpages&#x27; ];
                
                	if ( ! totalPages || totalPages === &#x27;0&#x27; ) {
                		// No paging: return as-is
                		return result;
                	}
                
                	// Decode the link header object
                	var links = result.headers.link ? parseLinkHeader( result.headers.link ) : {};
                
                	// Store pagination data from response headers on the response collection
                	result.body._paging = {
                		total: result.headers[ &#x27;x-wp-total&#x27; ],
                		totalPages: totalPages,
                		links: links
                	};
                
                	// Create a WPRequest instance pre-bound to the &quot;next&quot; page, if available
                	if ( links.next ) {
                		result.body._paging.next = new WPRequest({
                			transport: httpTransport,
                			endpoint: mergeUrl( endpoint, links.next )
                		});
                	}
                
                	// Create a WPRequest instance pre-bound to the &quot;prev&quot; page, if available
                	if ( links.prev ) {
                		result.body._paging.prev = new WPRequest({
                			transport: httpTransport,
                			endpoint: mergeUrl( endpoint, links.prev )
                		});
                	}
                
                	return result;
                }
                
                // HTTP-Related Helpers
                // ====================
                
                /**
                 * Submit the provided superagent request object, invoke a callback (if it was
                 * provided), and return a promise to the response from the HTTP request.
                 *
                 * @param {Object} request A superagent request object
                 * @param {Function} callback A callback function (optional)
                 * @param {Function} transform A function to transform the result data
                 * @return {Promise} A promise to the superagent request
                 */
                function invokeAndPromisify( request, callback, transform ) {
                
                	return new Promise(function( resolve, reject ) {
                		// Fire off the result
                		request.end(function( err, result ) {
                
                			// Return the results as a promise
                			if ( err || result.error ) {
                				reject( err || result.error );
                			} else {
                				resolve( result );
                			}
                		});
                	}).then( transform ).then(function( result ) {
                		// If a node-style callback was provided, call it, but also return the
                		// result value for use via the returned Promise
                		if ( callback &amp;&amp; typeof callback === &#x27;function&#x27; ) {
                			callback( null, result );
                		}
                		return result;
                	}, function( err ) {
                		// If a callback was provided, ensure it is called with the error; otherwise
                		// re-throw the error so that it can be handled by a Promise .catch or .then
                		if ( callback &amp;&amp; typeof callback === &#x27;function&#x27; ) {
                			callback( err );
                		} else {
                			throw err;
                		}
                	});
                }
                
                /**
                 * Return the body of the request, augmented with pagination information if the
                 * result is a paged collection.
                 *
                 * @method returnBody
                 * @private
                 * @param {WPRequest} wpreq The WPRequest representing the returned HTTP response
                 * @param {Object} result The results from the HTTP request
                 * @return {Object} The &quot;body&quot; property of the result, conditionally augmented with
                 *                  pagination information if the result is a partial collection.
                 */
                function returnBody( wpreq, result ) {
                	var endpoint = wpreq._options.endpoint;
                	var httpTransport = wpreq.transport;
                	return paginateResponse( result, endpoint, httpTransport ).body;
                }
                
                /**
                 * Extract and return the headers property from a superagent response object
                 *
                 * @param {Object} result The results from the HTTP request
                 * @return {Object} The &quot;headers&quot; property of the result
                 */
                function returnHeaders( result ) {
                	return result.headers;
                }
                
                // HTTP Methods: Private HTTP-verb versions
                // ========================================
                
                /**
                 * @method _httpGet
                 * @async
                 * @private
                 * @param {WPRequest} wpreq A WPRequest query object
                 * @param {Function} [callback] A callback to invoke with the results of the GET request
                 * @return {Promise} A promise to the results of the HTTP request
                 */
                function _httpGet( wpreq, callback ) {
                	checkMethodSupport( &#x27;get&#x27;, wpreq );
                	var url = wpreq.toString();
                
                	var request = _auth( agent.get( url ), wpreq._options );
                
                	return invokeAndPromisify( request, callback, returnBody.bind( null, wpreq ) );
                }
                
                /**
                 * Invoke an HTTP &quot;POST&quot; request against the provided endpoint
                 * @method _httpPost
                 * @async
                 * @private
                 * @param {WPRequest} wpreq A WPRequest query object
                 * @param {Object} data The data for the POST request
                 * @param {Function} [callback] A callback to invoke with the results of the POST request
                 * @return {Promise} A promise to the results of the HTTP request
                 */
                function _httpPost( wpreq, data, callback ) {
                	checkMethodSupport( &#x27;post&#x27;, wpreq );
                	var url = wpreq.toString();
                	data = data || {};
                	var request = _auth( agent.post( url ), wpreq._options, true );
                
                	if ( wpreq._attachment ) {
                		// Data must be form-encoded alongside image attachment
                		request = _reduce( data, function( req, value, key ) {
                			return req.field( key, value );
                		}, request.attach( &#x27;file&#x27;, wpreq._attachment, wpreq._attachmentName ) );
                	} else {
                		request = request.send( data );
                	}
                
                	return invokeAndPromisify( request, callback, returnBody.bind( null, wpreq ) );
                }
                
                /**
                 * @method _httpPut
                 * @async
                 * @private
                 * @param {WPRequest} wpreq A WPRequest query object
                 * @param {Object} data The data for the PUT request
                 * @param {Function} [callback] A callback to invoke with the results of the PUT request
                 * @return {Promise} A promise to the results of the HTTP request
                 */
                function _httpPut( wpreq, data, callback ) {
                	checkMethodSupport( &#x27;put&#x27;, wpreq );
                	var url = wpreq.toString();
                	data = data || {};
                
                	var request = _auth( agent.put( url ), wpreq._options, true ).send( data );
                
                	return invokeAndPromisify( request, callback, returnBody.bind( null, wpreq ) );
                }
                
                /**
                 * @method _httpDelete
                 * @async
                 * @private
                 * @param {WPRequest} wpreq A WPRequest query object
                 * @param {Object} [data] Data to send along with the DELETE request
                 * @param {Function} [callback] A callback to invoke with the results of the DELETE request
                 * @return {Promise} A promise to the results of the HTTP request
                 */
                function _httpDelete( wpreq, data, callback ) {
                	if ( ! callback &amp;&amp; typeof data === &#x27;function&#x27; ) {
                		callback = data;
                		data = null;
                	}
                	checkMethodSupport( &#x27;delete&#x27;, wpreq );
                	var url = wpreq.toString();
                	var request = _auth( agent.del( url ), wpreq._options, true ).send( data );
                
                	return invokeAndPromisify( request, callback, returnBody.bind( null, wpreq ) );
                }
                
                /**
                 * @method _httpHead
                 * @async
                 * @private
                 * @param {WPRequest} wpreq A WPRequest query object
                 * @param {Function} [callback] A callback to invoke with the results of the HEAD request
                 * @return {Promise} A promise to the header results of the HTTP request
                 */
                function _httpHead( wpreq, callback ) {
                	checkMethodSupport( &#x27;head&#x27;, wpreq );
                	var url = wpreq.toString();
                	var request = _auth( agent.head( url ), wpreq._options );
                
                	return invokeAndPromisify( request, callback, returnHeaders );
                }
                
                module.exports = {
                	delete: _httpDelete,
                	get: _httpGet,
                	head: _httpHead,
                	post: _httpPost,
                	put: _httpPut
                };
                
                    </pre>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
